<table>
<% @teams.each do |team| %>
  <tr style="padding-bottom:50px">
    <td>
      <h2>
        <%= team.name %>
        <% active_days_count = @team_days[team.id].select {|day, hours| hours.to_f > 1}.length %>
        <% if active_days_count > 0 %>
          <i class="icon-circle" style="color:<%= amount_to_color(@team_days[team.id][:cumulative]) %>" title="<%= round(@team_days[team.id][:cumulative]) %>"></i>
        <% end %>
      </h2>
      <table border="0" cellpadding="2">
        <tr>
          <% %w[Su M T W Th F S].each do |day| %>
            <th><%= day %></th>
          <% end %>
        </tr>
        <tr>
          <% @start_date.step(@end_date) do |day| %>
            <td>
              <% amount = (@team_days[team.id][day] || 0)
                 if amount > 0
                   amount = round(amount / @marches[team.id].select {|member, days| days[day].to_f > 0}.length)
                 else
                  next
                 end %>
              <% if @team_days[team.id][day] && (amount > 4 || (1..5).include?(day.wday)) %>
                <i class="icon-circle" style="color:<%= amount_to_color(amount) %>" title="<%= amount %>"></i>
              <% end %>
            </td>
          <% end %>
        </tr>
          <% @start_date.step(@end_date) do |day| %>
            <td>
              <% amount = (@team_days[team.id][day] || 0)
                 if amount > 0
                   amount = round(amount / @marches[team.id].select {|member, days| days[day].to_f > 0}.length)
                 else
                  next
                 end %>
              <% if @team_days[team.id][day] && (amount > 4 || (1..5).include?(day.wday)) %>
                <%= amount %>
              <% end %>
            </td>
          <% end %>
        </tr>
      </table>
    </td>

    <% team.team_members.each do |team_member| %>
      <td>
        <div style="border:1px solid black; margin:10px; padding: 10px">
          <h3><%= team_member.name %></h3>
          <div>
            <%= render 'rescue_time', team_member: team_member, team: team if @marches[team.id] %>
          </div>
          <div>
            <% commit_count = @events[team_member.id].length %>
            <% if commit_count > 0 %>
              <%= link_to("commits (#{commit_count})", '#', onclick: "$('#js-commits_#{team_member.github_login}').dialog({width: 'auto'});return false;") %>
              <div id="js-commits_<%= team_member.github_login %>" style="display:none">
                <%= render 'events', team_member: team_member %>
              </div>
            <% end %>
          </div>
        </div>
      </td>
    <% end %>
  </tr>
<% end %>
</table>
<%= link_to('Previous week', teams_path(start_date: @start_date - 1.week), style: 'float:left') %>
<% if @start_date < Date.today.beginning_of_week(:sunday) %>
  <%= link_to('Next week', teams_path(start_date: @start_date + 1.week), style: 'float:right') %>
<% end %>

